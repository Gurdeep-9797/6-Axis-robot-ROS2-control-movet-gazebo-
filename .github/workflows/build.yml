name: Build & Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  VCPKG_DEFAULT_TRIPLET: x64-windows

jobs:
  build:
    # Pin to windows-2022 for reproducibility (windows-latest may change)
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4

      # Setup MSVC environment explicitly
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # Cache vcpkg binary packages (NOT the vcpkg tree itself)
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/buildtrees
            C:/vcpkg/packages
            C:/vcpkg/installed
          key: vcpkg-${{ runner.os }}-${{ hashFiles('RobotSimulator_CPP/vcpkg.json') }}-v2
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: 'C:/vcpkg'
          vcpkgGitCommitId: '8cf84605ce9764de46caeb47b9e710db9493add9'
          vcpkgJsonGlob: 'RobotSimulator_CPP/vcpkg.json'

      - name: Configure CMake
        run: |
          cmake -S RobotSimulator_CPP -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Run Component Tests
        run: |
          cd build
          ctest -C Release --output-on-failure
          cd ..

      - name: Package / Deploy
        run: |
          mkdir Dist
          copy build\Release\RobotSimulator_CPP.exe Dist\
          if exist build\Release\*.dll copy build\Release\*.dll Dist\
          if exist RobotSimulator_CPP\assets (xcopy RobotSimulator_CPP\assets Dist\assets /E /I /Y)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RobotSimulator_Release
          path: Dist/
