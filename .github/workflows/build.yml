name: Build & Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Enable GitHub Actions Cache
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/packages
            C:/vcpkg/downloads
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('RobotSimulator_CPP/vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: 'C:/vcpkg'
          vcpkgGitCommitId: '8cf84605ce9764de46caeb47b9e710db9493add9'
          vcpkgJsonGlob: 'RobotSimulator_CPP/vcpkg.json'

      - name: Configure CMake
        run: |
          cmake -S RobotSimulator_CPP -B build -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Build
        run: cmake --build build --config Release

      - name: Run Component Tests
        run: |
          cd build
          ctest -C Release --output-on-failure
          cd ..

      - name: Package / Deploy
        run: |
          mkdir Dist
          copy build\Release\RobotSimulator_CPP.exe Dist\
          if exist build\Release\*.dll copy build\Release\*.dll Dist\
          xcopy RobotSimulator_CPP\assets Dist\assets /E /I /Y
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RobotSimulator_Release
          path: Dist/
