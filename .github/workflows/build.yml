name: Build & Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  VCPKG_DEFAULT_TRIPLET: x64-windows
  VCPKG_BINARY_SOURCES: 'clear;x-gha,readwrite'

permissions:
  contents: read
  actions: write

jobs:
  build:
    # Use standard windows-2022 image (VS 2022).
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4

      - name: Setup vcpkg (x-gha caching)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: 'C:/vcpkg'
          vcpkgGitCommitId: '8cf84605ce9764de46caeb47b9e710db9493add9'
          vcpkgJsonGlob: 'RobotSimulator_CPP/vcpkg.json'

      - name: Configure CMake
        run: |
          cmake -S RobotSimulator_CPP -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Build
        id: build_step
        run: cmake --build build --config Release --parallel -- /verbosity:minimal
        continue-on-error: true

      - name: Show Build Errors
        if: steps.build_step.outcome == 'failure'
        run: |
          echo "::error::Build failed! Check the Build step output above for MSVC error details."
          exit 1

      - name: Run Component Tests
        if: steps.build_step.outcome == 'success'
        run: |
          cd build
          ctest -C Release --output-on-failure
          cd ..

      - name: Package / Deploy
        run: |
          mkdir Dist
          copy build\Release\RobotSimulator_CPP.exe Dist\
          if exist build\Release\*.dll copy build\Release\*.dll Dist\
          if exist RobotSimulator_CPP\assets (xcopy RobotSimulator_CPP\assets Dist\assets /E /I /Y)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RobotSimulator_Release
          path: Dist/
