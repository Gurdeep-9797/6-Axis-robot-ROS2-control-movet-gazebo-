version: '3.8'

services:
  ros_core:
    image: robotics_base:latest
    container_name: ros_core
    command: bash -c "source /opt/ros/humble/setup.bash && cd /ros_ws && rm -f build_finished && colcon build --packages-ignore robot_tests && touch build_finished && source install/setup.bash && ros2 launch robot_description display.launch.py"
    environment:
      - ROS_DOMAIN_ID=42
    volumes:
      - ${PROJECT_ROOT}:/ros_ws
    networks:
      - robot_net

  moveit:
    image: robotics_base:latest
    container_name: moveit
    depends_on:
      - ros_core
    volumes:
      - ${PROJECT_ROOT}:/ros_ws
    command: bash -c "source /opt/ros/humble/setup.bash && while [ ! -f /ros_ws/build_finished ]; do sleep 2; done; source /ros_ws/install/setup.bash && ros2 launch robot_moveit_config move_group.launch.py"
    environment:
      - ROS_DOMAIN_ID=42
      - DISPLAY=host.docker.internal:0 # for GUI
    networks:
      - robot_net
    deploy:
      resources:
        limits:
          memory: 4G

  gazebo:
    image: robotics_base:latest
    container_name: gazebo
    depends_on:
      - ros_core
    volumes:
      - ${PROJECT_ROOT}:/ros_ws
    environment:
      - ROS_DOMAIN_ID=42
      - DISPLAY=host.docker.internal:0
    command: bash -c "source /opt/ros/humble/setup.bash && while [ ! -f /ros_ws/build_finished ]; do sleep 2; done; source /ros_ws/install/setup.bash && ros2 launch robot_gazebo gazebo.launch.py"
    networks:
      - robot_net
    # GPU Removed for compatibility
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [ gpu ]

  hardware_bridge:
    image: robotics_base:latest
    container_name: bridge
    depends_on:
      - gazebo
      - moveit
    volumes:
      - ${PROJECT_ROOT}:/ros_ws
    command: bash -c "source /opt/ros/humble/setup.bash && while [ ! -f /ros_ws/build_finished ]; do sleep 2; done; source /ros_ws/install/setup.bash && ros2 run robot_hardware_bridge bridge_node"
    environment:
      - ROS_DOMAIN_ID=42
    networks:
      - robot_net

networks:
  robot_net:
    driver: bridge
