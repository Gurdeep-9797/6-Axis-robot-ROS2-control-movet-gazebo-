<mah:MetroWindow x:Class="RobotSimulator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:h="http://helix-toolkit.org/wpf"
        mc:Ignorable="d"
        Title="6-AXIS | DIGITAL TWIN CNTRL [PRO]" Height="900" Width="1600"
        GlowBrush="{DynamicResource MahApps.Brushes.Accent}"
        ResizeMode="CanResizeWithGrip"
        WindowStartupLocation="CenterScreen">

    <mah:MetroWindow.RightWindowCommands>
        <mah:WindowCommands>
            <Button Content="EMERGENCY STOP" Background="#E74C3C" Foreground="White" FontWeight="Bold" Click="EStop_Click"/>
        </mah:WindowCommands>
    </mah:MetroWindow.RightWindowCommands>

    <Grid Background="#F0F0F0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Toolbar -->
            <RowDefinition Height="*"/>    <!-- Main Content -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- 1. TOOLBAR -->
        <Border Grid.Row="0" Background="White" BorderBrush="#EEE" BorderThickness="0,0,0,1">
            <ToolBarTray Background="White">
                <ToolBar Background="White" ToolBarTray.IsLocked="True">
                    <Button ToolTip="Open Project" Margin="0,0,5,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="FolderOpen" Width="16" Height="16" Foreground="#555"/>
                            <TextBlock Text="Open" Margin="5,0,0,0" Foreground="#333"/>
                        </StackPanel>
                    </Button>
                    <Button ToolTip="Save Project" Margin="0,0,5,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="ContentSave" Width="16" Height="16" Foreground="#555"/>
                            <TextBlock Text="Save" Margin="5,0,0,0" Foreground="#333"/>
                        </StackPanel>
                    </Button>
                    <Separator/>
                    <Button ToolTip="Connect ROS" Click="ConnectRos_Click" Margin="0,0,5,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="LanConnect" Width="16" Height="16" Foreground="#007ACC"/>
                            <TextBlock Text="Connect ROS" Margin="5,0,0,0" Foreground="#333"/>
                        </StackPanel>
                    </Button>
                    <Button ToolTip="Scan USB Devices" Click="ScanDevices_Click" Margin="0,0,5,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Usb" Width="16" Height="16" Foreground="#333"/>
                            <TextBlock Text="Scan USB" Margin="5,0,0,0" Foreground="#333"/>
                        </StackPanel>
                    </Button>
                    <Separator/>
                    <Button ToolTip="Run Program" Click="RunProgram_Click" Margin="0,0,5,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Play" Width="16" Height="16" Foreground="#27AE60"/>
                            <TextBlock Text="Run" Margin="5,0,0,0" Foreground="#333"/>
                        </StackPanel>
                    </Button>
                    <Button ToolTip="Stop" Click="EStop_Click" Margin="0,0,5,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Stop" Width="16" Height="16" Foreground="#E74C3C"/>
                            <TextBlock Text="Stop" Margin="5,0,0,0" Foreground="#333"/>
                        </StackPanel>
                    </Button>
                </ToolBar>
            </ToolBarTray>
        </Border>

        <!-- 2. MAIN SPLIT LAYOUT -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="340"/> <!-- Work Tree -->
                <ColumnDefinition Width="*"/>   <!-- Viewport -->
                <ColumnDefinition Width="350"/> <!-- Properties -->
            </Grid.ColumnDefinitions>

            <!-- LEFT: WORK TREE -->
            <Border Grid.Column="0" Background="White" BorderBrush="#EEE" BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="SCENE EXPLORER" Foreground="#999" FontWeight="Bold" Margin="15,10"/>
                    
                    <TreeView Grid.Row="1" x:Name="workTree" Background="Transparent" BorderThickness="0" Margin="5">
                        <TreeView.Resources>
                            <Style TargetType="TreeViewItem" BasedOn="{StaticResource MahApps.Styles.TreeViewItem}">
                                <Setter Property="Foreground" Value="#333"/>
                                <Setter Property="FontSize" Value="13"/>
                            </Style>
                        </TreeView.Resources>
                        
                        <!-- Populated manually or via code-behind to resemble Scene Graph -->
                        <TreeViewItem IsExpanded="True">
                            <TreeViewItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <iconPacks:PackIconMaterial Kind="RobotIndustrial" Margin="0,0,5,0" Foreground="#E67E22"/>
                                    <TextBlock Text="ABB IRB 120 (Robot)"/>
                                </StackPanel>
                            </TreeViewItem.Header>
                            <!-- Links will be populated here -->
                            <TreeViewItem Header="Base (Link 0)"/>
                            <TreeViewItem Header="Shoulder (Link 1)"/>
                            <TreeViewItem Header="Arm (Link 2)"/>
                            <TreeViewItem Header="Elbow (Link 3)"/>
                            <TreeViewItem Header="Forearm (Link 4)"/>
                            <TreeViewItem Header="Wrist (Link 5)"/>
                            <TreeViewItem Header="Flange (Link 6)"/>
                             <TreeViewItem IsExpanded="True">
                                <TreeViewItem.Header>
                                    <StackPanel Orientation="Horizontal">
                                        <iconPacks:PackIconMaterial Kind="AxisArrow" Margin="0,0,5,0" Foreground="#E74C3C"/>
                                        <TextBlock Text="TCP (End Effector)"/>
                                    </StackPanel>
                                </TreeViewItem.Header>
                            </TreeViewItem>
                        </TreeViewItem>

                         <TreeViewItem IsExpanded="True" Margin="0,10,0,0">
                            <TreeViewItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <iconPacks:PackIconMaterial Kind="FileCode" Margin="0,0,5,0" Foreground="#F1C40F"/>
                                    <TextBlock Text="Active Program"/>
                                </StackPanel>
                            </TreeViewItem.Header>
                            <TreeViewItem>
                                <TreeViewItem.Header>
                                    <StackPanel Orientation="Horizontal">
                                         <Button Content="Add Waypoint" Click="AddPoint_Click" Style="{DynamicResource MahApps.Styles.Button.Chromeless}" Padding="5,2" Margin="0" BorderBrush="#DDD" BorderThickness="1"/>
                                         <Button Content="Clear" Click="ClearPoints_Click" Style="{DynamicResource MahApps.Styles.Button.Chromeless}" Padding="5,2" Margin="5,0,0,0" Foreground="#E74C3C"/>
                                    </StackPanel>
                                </TreeViewItem.Header>
                            </TreeViewItem>
                            
                            <!-- Program Points List -->
                            <ListBox x:Name="pointList" Background="Transparent" BorderThickness="0" Foreground="#555" Height="200" MouseDoubleClick="GotoPoint_Click"/>
                        </TreeViewItem>
                        
                        <TreeViewItem IsExpanded="True" Margin="0,10,0,0">
                            <TreeViewItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <iconPacks:PackIconMaterial Kind="CubeOutline" Margin="0,0,5,0" Foreground="#AAA"/>
                                    <TextBlock Text="Environment"/>
                                </StackPanel>
                            </TreeViewItem.Header>
                            <TreeViewItem Header="Floor Grid"/>
                            <TreeViewItem Header="Worktable"/>
                            <TreeViewItem Header="Safety Fence"/>
                            <TreeViewItem>
                                <TreeViewItem.Header>
                                    <StackPanel Orientation="Horizontal">
                                         <Button Content="Import STL..." Click="ImportSTL_Click" Style="{DynamicResource MahApps.Styles.Button.Chromeless}" Padding="0"/>
                                    </StackPanel>
                                </TreeViewItem.Header>
                            </TreeViewItem>
                        </TreeViewItem>
                        
                    </TreeView>
                </Grid>
            </Border>

            <!-- CENTER: 3D VIEWPORT -->
            <Grid Grid.Column="1" Background="#E3E5E8">
                <!-- Drop Shadow for "Floating" effect -->
                <Border Background="Transparent" Margin="0">
                     <Grid>
                        <h:HelixViewport3D x:Name="viewPort3d" 
                                         ZoomExtentsWhenLoaded="True" 
                                         ShowCoordinateSystem="True"
                                         ShowViewCube="True"
                                         Background="#E3E5E8">
                            <h:SunLight/>
                            <h:DefaultLights/>
                            <h:GridLinesVisual3D Width="10" Length="10" MinorDistance="1" MajorDistance="1" Thickness="0.01" Fill="Gray"/>
                            
                            <ModelVisual3D x:Name="robotVisual"/>
                            <ModelVisual3D x:Name="ghostVisual"/>
                            <ModelVisual3D x:Name="environmentVisual"/>
                            
                            <!-- Path Tracing Tube -->
                            <h:TubeVisual3D x:Name="pathTraceVisual" Diameter="0.01" ThetaDiv="10" Fill="#E74C3C"/>
                        </h:HelixViewport3D>

                        <!-- Overlay Info -->
                        <StackPanel VerticalAlignment="Top" HorizontalAlignment="Left" Margin="10">
                            <Border Background="#88FFFFFF" CornerRadius="5" Padding="8">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" Opacity="0.1"/>
                                </Border.Effect>
                                <StackPanel>
                                    <TextBlock Text="CAM: Free Orbit" Foreground="#666" FontSize="10"/>
                                    <CheckBox x:Name="chkGhost" Content="Show Ghost (Target)" IsChecked="True" Foreground="#333" Margin="0,5,0,0"/>
                                    <CheckBox x:Name="chkCoords" Content="Show Coordinates" IsChecked="True" Click="ToggleCoords_Click" Foreground="#333"/>
                                    <CheckBox x:Name="chkTrace" Content="Show Path Trace" IsChecked="True" Foreground="#333" Margin="0,0,0,0"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                         
                         <!-- Connection Badge -->
                         <Border VerticalAlignment="Top" HorizontalAlignment="Right" Margin="10" 
                                 Background="#DDFFFFFF" CornerRadius="5" Padding="10" BorderBrush="#EEE" BorderThickness="1">
                             <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" Opacity="0.1"/>
                             </Border.Effect>
                            <StackPanel Orientation="Horizontal">
                                <Ellipse x:Name="rosIndicator" Width="10" Height="10" Fill="#E74C3C" Margin="0,2,8,0"/>
                                <StackPanel>
                                    <TextBlock x:Name="rosStatusText" Text="ROS: DISCONNECTED" FontWeight="Bold" Foreground="#333" FontSize="11"/>
                                    <TextBlock x:Name="rosLatencyText" Text="Latency: --" Foreground="#888" FontSize="10"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <!-- RIGHT: PROPERTIES -->
            <Border Grid.Column="2" Background="White" BorderBrush="#EEE" BorderThickness="1,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Text="PROPERTIES" Foreground="#999" FontWeight="Bold" Margin="15,10"/>
                    
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="15">
                            <!-- Joint Controls -->
                            <Expander Header="Joint Control" IsExpanded="True" Style="{DynamicResource MahApps.Styles.Expander}">
                                <StackPanel Margin="0,10,0,0">
                                    <!-- J1 -->
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="J1" Foreground="#333" VerticalAlignment="Center"/>
                                        <Slider Grid.Column="1" x:Name="sliJ1" Minimum="-180" Maximum="180" ValueChanged="Slider_ValueChanged" Margin="10,0"/>
                                        <TextBlock Grid.Column="2" x:Name="lblJ1" Text="0.0°" Foreground="#777" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                    <!-- J2 -->
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="J2" Foreground="#333" VerticalAlignment="Center"/>
                                        <Slider Grid.Column="1" x:Name="sliJ2" Minimum="-90" Maximum="90" ValueChanged="Slider_ValueChanged" Margin="10,0"/>
                                        <TextBlock Grid.Column="2" x:Name="lblJ2" Text="0.0°" Foreground="#777" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                    <!-- J3 -->
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="J3" Foreground="#333" VerticalAlignment="Center"/>
                                        <Slider Grid.Column="1" x:Name="sliJ3" Minimum="-135" Maximum="135" ValueChanged="Slider_ValueChanged" Margin="10,0"/>
                                        <TextBlock Grid.Column="2" x:Name="lblJ3" Text="0.0°" Foreground="#777" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                    <!-- J4 -->
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="J4" Foreground="#333" VerticalAlignment="Center"/>
                                        <Slider Grid.Column="1" x:Name="sliJ4" Minimum="-180" Maximum="180" ValueChanged="Slider_ValueChanged" Margin="10,0"/>
                                        <TextBlock Grid.Column="2" x:Name="lblJ4" Text="0.0°" Foreground="#777" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                    <!-- J5 -->
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="J5" Foreground="#333" VerticalAlignment="Center"/>
                                        <Slider Grid.Column="1" x:Name="sliJ5" Minimum="-180" Maximum="180" ValueChanged="Slider_ValueChanged" Margin="10,0"/>
                                        <TextBlock Grid.Column="2" x:Name="lblJ5" Text="0.0°" Foreground="#777" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                    <!-- J6 -->
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="J6" Foreground="#333" VerticalAlignment="Center"/>
                                        <Slider Grid.Column="1" x:Name="sliJ6" Minimum="-180" Maximum="180" ValueChanged="Slider_ValueChanged" Margin="10,0"/>
                                        <TextBlock Grid.Column="2" x:Name="lblJ6" Text="0.0°" Foreground="#777" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                </StackPanel>
                            </Expander>

                            <Expander Header="Cartesian (TCP)" IsExpanded="True" Margin="0,10,0,0" Style="{DynamicResource MahApps.Styles.Expander}">
                                <UniformGrid Columns="2" Margin="0,10">
                                    <TextBlock x:Name="txtX" Text="X: 0.00" Foreground="#555" Margin="0,2"/>
                                    <TextBlock x:Name="txtR" Text="R: 0.00" Foreground="#555" Margin="0,2"/>
                                    <TextBlock x:Name="txtY" Text="Y: 0.00" Foreground="#555" Margin="0,2"/>
                                    <TextBlock x:Name="txtP" Text="P: 0.00" Foreground="#555" Margin="0,2"/>
                                    <TextBlock x:Name="txtZ" Text="Z: 0.00" Foreground="#555" Margin="0,2"/>
                                    <TextBlock x:Name="txtYaw" Text="Y: 0.00" Foreground="#555" Margin="0,2"/>
                                </UniformGrid>
                            </Expander>

                            <Expander Header="Simulation Settings" IsExpanded="True" Margin="0,10,0,0" Style="{DynamicResource MahApps.Styles.Expander}">
                                <StackPanel Margin="0,10">
                                    <TextBox x:Name="rosUri" Text="ws://localhost:9090" mah:TextBoxHelper.Watermark="ROS Bridge URI" Margin="0,0,0,5"/>
                                    <CheckBox x:Name="chkSync" Content="Strict Digital Twin Sync" IsChecked="True" ToolTip="3D model only moves when ROS confirms state" Margin="0,5"/>
                                    
                                    <Separator Margin="0,10"/>
                                    <TextBlock Text="Legacy USB" FontWeight="Bold" Margin="0,0,0,5" Foreground="#555"/>
                                    <ListBox x:Name="deviceList" MaxHeight="80" BorderThickness="1" BorderBrush="#EEE" Background="#F9F9F9" Foreground="#333"/>
                                    <Button x:Name="btnSerialConnect" Content="Connect Selected" Click="ConnectSerial_Click" Margin="0,5"/>
                                </StackPanel>
                            </Expander>
                            
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- 3. STATUS BAR -->
        <StatusBar Grid.Row="2" Background="#E74C3C" Foreground="White">
            <StatusBarItem>
                <iconPacks:PackIconMaterial Kind="Information" Width="14" Height="14" VerticalAlignment="Center" Margin="0,0,5,0"/>
            </StatusBarItem>
            <StatusBarItem>
                <TextBlock x:Name="statusText" Text="Ready"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                     <iconPacks:PackIconMaterial Kind="Api" Width="14" Height="14" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="#DDFFFFFF"/>
                     <TextBlock Text="API: :8085" Margin="0,0,15,0"/>
                     <TextBlock Text="V4.0.0 | PRO EDITION"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

    </Grid>
</mah:MetroWindow>
