# Robot System Docker Compose - REAL Mode Override
# Use: docker compose -f docker-compose.yml -f docker-compose.real.yml up -d
# WARNING: This connects to real hardware. Ensure safety procedures are followed.

services:
  # Override bridge to use REAL backend
  bridge:
    environment:
      - ROBOT_MODE=REAL
      - CONTROLLER_TYPE=REAL
      - CONTROLLER_IP=${CONTROLLER_IP}
      - CONTROLLER_PORT=${CONTROLLER_PORT}
      - CONTROLLER_PROTO=${CONTROLLER_PROTO}
    # For serial/USB access to controller
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    privileged: false

  # Optional UI (for monitoring only - UI has NO control authority)
  ui:
    build:
      context: .
      dockerfile: docker/Dockerfile.ui
    container_name: robot_ui
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID}
      - UI_PORT=${UI_PORT}
      - ROBOT_MODE=REAL
    ports:
      - "${UI_PORT}:${UI_PORT}"
    volumes:
      - ./src:/ros_ws/src:ro
    depends_on:
      - ros_core
      - moveit
    networks:
      - robot_net
    profiles:
      - ui
    restart: unless-stopped

  # Optional Analysis (read-only, non-blocking)
  analysis:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros
    container_name: robot_analysis
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION}
      - ENABLE_ACCURACY_ANALYSIS=${ENABLE_ACCURACY_ANALYSIS}
      - LOG_LEVEL=${LOG_LEVEL}
    volumes:
      - ./src:/ros_ws/src:ro
      - ./logs/analysis:/ros_ws/logs
    command: ros2 launch robot_analysis analysis.launch.py
    depends_on:
      - ros_core
      - bridge
    networks:
      - robot_net
    profiles:
      - analysis
    restart: unless-stopped
