<Window x:Class="TeachPendant_WPF.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:hx="http://helix-toolkit.org/wpf"
        xmlns:viewmodels="clr-namespace:TeachPendant_WPF.ViewModels"
        xmlns:local="clr-namespace:TeachPendant_WPF.Views"
        mc:Ignorable="d"
        Title="FR-HMI Teach Pendant" Height="1080" Width="1920"
        Style="{StaticResource FRWindowStyle}">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="40" ResizeBorderThickness="5" GlassFrameThickness="0" CornerRadius="0"/>
    </WindowChrome.WindowChrome>

    <Grid Background="{StaticResource Bg.Deepest}">
        <Grid.RowDefinitions>
            <!-- Top Ribbon -->
            <RowDefinition Height="46"/>
            <!-- 3-Pane Content -->
            <RowDefinition Height="*"/>
            <!-- Bottom Console -->
            <RowDefinition Height="200"/>
        </Grid.RowDefinitions>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- TOP RIBBON                                                  -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="0" Background="{StaticResource Bg.Surface1}" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,0,0,1" WindowChrome.IsHitTestVisibleInChrome="False">
            <Grid Margin="12,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/> <!-- Brand / Menus -->
                    <ColumnDefinition Width="Auto"/> <!-- Modes -->
                    <ColumnDefinition Width="*"/>    <!-- Spacer -->
                    <ColumnDefinition Width="Auto"/> <!-- Status -->
                    <ColumnDefinition Width="Auto"/> <!-- Window Controls -->
                </Grid.ColumnDefinitions>

                <!-- Brand -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="FR-STUDIO IDE" FontWeight="Bold" Foreground="{StaticResource Palette.Primary.Brand}" FontSize="13" Margin="0,0,20,0"/>
                    <Button Content="File" Style="{StaticResource FRButtonStyle}" Background="Transparent" BorderThickness="0" WindowChrome.IsHitTestVisibleInChrome="True"/>
                    <Button Content="Edit" Style="{StaticResource FRButtonStyle}" Background="Transparent" BorderThickness="0" WindowChrome.IsHitTestVisibleInChrome="True"/>
                    <Button Content="View" Style="{StaticResource FRButtonStyle}" Background="Transparent" BorderThickness="0" WindowChrome.IsHitTestVisibleInChrome="True"/>
                    <Button Content="Robot" Style="{StaticResource FRButtonStyle}" Background="Transparent" BorderThickness="0" WindowChrome.IsHitTestVisibleInChrome="True"/>
                    <Button Content="Settings" Style="{StaticResource FRButtonStyle}" Background="Transparent" BorderThickness="0" Command="{Binding OpenSettingsCommand}" WindowChrome.IsHitTestVisibleInChrome="True"/>
                </StackPanel>

                <!-- Mode & Execution (SIM/REAL + Start/Stop) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0,0,0" WindowChrome.IsHitTestVisibleInChrome="True">
                    <Border Background="{StaticResource Bg.Deepest}" CornerRadius="3" Padding="2" Margin="0,0,16,0">
                        <StackPanel Orientation="Horizontal">
                            <RadioButton Content="SIM" Style="{StaticResource FRToggleButtonStyle}" IsChecked="{Binding GlobalState.IsSimulationMode}"/>
                            <RadioButton Content="REAL" Style="{StaticResource FRToggleButtonStyle}" IsChecked="{Binding GlobalState.IsRealMode}" Command="{Binding GlobalState.ToggleModeCommand}"/>
                        </StackPanel>
                    </Border>
                    
                    <Button Style="{StaticResource FRButtonStyle}" Foreground="{StaticResource Accent.Real}" Command="{Binding StartProgramCommand}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="â–¶" Margin="0,0,4,0"/>
                            <TextBlock Text="Running"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource FRButtonStyle}" Foreground="{StaticResource Accent.Error}" Command="{Binding StopProgramCommand}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="â– " Margin="0,0,4,0"/>
                            <TextBlock Text="ABORT"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Status Badge -->
                <Border Grid.Column="3" Background="{StaticResource Bg.Deepest}" CornerRadius="12" Padding="12,4" Margin="0,0,16,0" VerticalAlignment="Center" BorderBrush="{StaticResource Border.Highlight}" BorderThickness="1">
                    <StackPanel Orientation="Horizontal">
                        <Ellipse Width="6" Height="6" Margin="0,0,6,0">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="{StaticResource Text.Muted}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding GlobalState.IsRunning}" Value="True">
                                            <Setter Property="Fill" Value="{StaticResource Accent.Real}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        <TextBlock Text="{Binding GlobalState.ExecutionStateText}" Foreground="{StaticResource Text.Primary}" FontSize="10" FontWeight="Bold"/>
                    </StackPanel>
                </Border>

                <!-- Window Controls -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center" WindowChrome.IsHitTestVisibleInChrome="True">
                    <Button Style="{StaticResource FRButtonStyle}" Content="ðŸ—•" Width="30" Height="24" Padding="0" Command="{Binding MinimizeWindowCommand}"/>
                    <Button Style="{StaticResource FRButtonStyle}" Content="ðŸ——" Width="30" Height="24" Padding="0" Command="{Binding MaximizeWindowCommand}"/>
                    <Button Style="{StaticResource FRButtonStyle}" Content="âœ•" Width="30" Height="24" Padding="0" Command="{Binding CloseWindowCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- 3-PANE EXPLORER                                             -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" MinWidth="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="350" MinWidth="300"/>
            </Grid.ColumnDefinitions>

            <!-- â•â•â•â•â•â•â• LEFT PANEL: Toolbox & Logic Tree â•â•â•â•â•â•â• -->
            <Border Grid.Column="0" Background="{StaticResource Bg.Surface1}" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Toolbox Component -->
                    <StackPanel Grid.Row="0" Margin="10,16,10,10">
                        <TextBlock Text="COMMAND TOOLBOX" FontWeight="Bold" Foreground="{StaticResource Text.Muted}" FontSize="11" Margin="0,0,0,8"/>
                        <WrapPanel Orientation="Horizontal" Focusable="False">
                            <Button Style="{StaticResource FRButtonStyle}" Command="{Binding AddInstructionCommand}" CommandParameter="LIN" Margin="0,0,4,4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="â†—" Foreground="#61AFEF" Margin="0,0,6,0"/>
                                    <TextBlock Text="LIN" Foreground="{StaticResource Text.Primary}"/>
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource FRButtonStyle}" Command="{Binding AddInstructionCommand}" CommandParameter="PTP" Margin="0,0,4,4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="â¤¿" Foreground="#C678DD" Margin="0,0,6,0"/>
                                    <TextBlock Text="PTP" Foreground="{StaticResource Text.Primary}"/>
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource FRButtonStyle}" Command="{Binding AddInstructionCommand}" CommandParameter="WAIT" Margin="0,0,4,4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="â±" Foreground="#D19A66" Margin="0,0,6,0"/>
                                    <TextBlock Text="WAIT" Foreground="{StaticResource Text.Primary}"/>
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource FRButtonStyle}" Command="{Binding AddInstructionCommand}" CommandParameter="SETDO" Margin="0,0,4,4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="âš¡" Foreground="#98C379" Margin="0,0,6,0"/>
                                    <TextBlock Text="IO" Foreground="{StaticResource Text.Primary}"/>
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource FRButtonStyle}" Command="{Binding CommandReg.ExecuteCommand}" CommandParameter="LoadURDF" Margin="0,0,4,4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="ðŸ¤–" Foreground="#E5C07B" Margin="0,0,6,0"/>
                                    <TextBlock Text="URDF" Foreground="{StaticResource Text.Primary}"/>
                                </StackPanel>
                            </Button>
                        </WrapPanel>
                    </StackPanel>
                    
                    <!-- Logic Tree Component -->
                    <Border Grid.Row="1" Margin="10,0,10,10" Background="{StaticResource Bg.Deepest}" CornerRadius="4" BorderBrush="{StaticResource Border.Default}" BorderThickness="1">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Border Grid.Row="0" Background="{StaticResource Bg.Surface2}" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,0,0,1" Padding="12,8">
                                <TextBlock Text="LOGIC TREE" FontWeight="Bold" Foreground="{StaticResource Text.Muted}" FontSize="11"/>
                            </Border>
                            <TreeView Grid.Row="1" ItemsSource="{Binding WorkTree.RootNodes}" Background="Transparent" BorderThickness="0" Margin="4">
                                <TreeView.ItemContainerStyle>
                                    <Style TargetType="TreeViewItem">
                                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                        <!-- Note: Using IsSelected TwoWay binding for now; real project may require a behavior to push selection to VM reliably -->
                                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                                        <Setter Property="Foreground" Value="{StaticResource Text.Primary}"/>
                                        <Setter Property="Padding" Value="4,2"/>
                                        <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                        <Setter Property="ContextMenu">
                                            <Setter.Value>
                                                <ContextMenu DataContext="{Binding PlacementTarget.Tag, RelativeSource={RelativeSource Self}}">
                                                    <MenuItem Header="Edit Parameter..." Command="{Binding WorkTree.EditSelectedCommand}"/>
                                                    <MenuItem Header="Duplicate" Command="{Binding WorkTree.DuplicateSelectedCommand}"/>
                                                    <Separator/>
                                                    <MenuItem Header="Delete Node" Command="{Binding WorkTree.DeleteSelectedCommand}" Foreground="#DF6965"/>
                                                </ContextMenu>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TreeView.ItemContainerStyle>
                                <TreeView.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                            <TextBlock Text="{Binding Icon}" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding Name}"/>
                                            <TextBlock Text="{Binding Value, StringFormat=' ({0})'}" Foreground="{StaticResource Text.Muted}" Margin="4,0,0,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Value}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>
                                    </HierarchicalDataTemplate>
                                </TreeView.ItemTemplate>
                            </TreeView>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- SPLITTER 1 -->
            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="{StaticResource Border.Default}"/>

            <!-- â•â•â•â•â•â•â• CENTER: 3D Workspace â•â•â•â•â•â•â• -->
            <Border Grid.Column="2" Background="{StaticResource Bg.Deepest}">
                <Grid>
                    <hx:HelixViewport3D ShowCoordinateSystem="True" ShowFrameRate="False" ZoomExtentsWhenLoaded="True" Background="Transparent" ShowViewCube="True">
                        <hx:DefaultLights/>
                        <!-- Grid floor -->
                        <hx:GridLinesVisual3D Width="2" Length="2" Thickness="0.002" MinorDistance="0.1" MajorDistance="0.5" Fill="#30888888"/>
                        <ModelVisual3D x:Name="RobotModelVisual"/>
                    </hx:HelixViewport3D>

                    <!-- Viewport overlay: TCP readout -->
                    <Border HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" Background="#901E2127" CornerRadius="6" Padding="12,8"
                            BorderBrush="{StaticResource Border.Highlight}" BorderThickness="1">
                        <StackPanel>
                            <TextBlock Text="TCP Position / Jts" FontWeight="Bold" Foreground="{StaticResource Text.Primary}" FontSize="11" Margin="0,0,0,4"/>
                            
                            <UniformGrid Columns="3" Rows="2">
                                <TextBlock Text="{Binding CurrentState.J1, StringFormat='J1: {0:F1}Â°'}" Foreground="{StaticResource Text.Muted}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding CurrentState.J2, StringFormat='J2: {0:F1}Â°'}" Foreground="{StaticResource Text.Muted}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding CurrentState.J3, StringFormat='J3: {0:F1}Â°'}" Foreground="{StaticResource Text.Muted}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding CurrentState.J4, StringFormat='J4: {0:F1}Â°'}" Foreground="{StaticResource Text.Muted}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding CurrentState.J5, StringFormat='J5: {0:F1}Â°'}" Foreground="{StaticResource Text.Muted}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding CurrentState.J6, StringFormat='J6: {0:F1}Â°'}" Foreground="{StaticResource Text.Muted}" FontSize="10" Margin="2"/>
                            </UniformGrid>
                            <Rectangle Height="1" Fill="{StaticResource Border.Default}" Margin="0,4"/>
                            <UniformGrid Columns="3">
                                <TextBlock Text="{Binding RobotVM.TcpX, StringFormat='X: {0:F1}'}" Foreground="{StaticResource Accent.Sim}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding RobotVM.TcpY, StringFormat='Y: {0:F1}'}" Foreground="{StaticResource Accent.Sim}" FontSize="10" Margin="2"/>
                                <TextBlock Text="{Binding RobotVM.TcpZ, StringFormat='Z: {0:F1}'}" Foreground="{StaticResource Accent.Sim}" FontSize="10" Margin="2"/>
                            </UniformGrid>
                        </StackPanel>
                    </Border>
                    
                    <!-- Viewport overlay: Active Line -->
                    <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10" Background="#901E2127" CornerRadius="6" Padding="10,6"
                            BorderBrush="{StaticResource Border.Highlight}" BorderThickness="1" Visibility="{Binding ProgramVM.ActiveLineNumber, Converter={StaticResource IntToVisibilityConverter}}">
                        <TextBlock Text="{Binding ProgramVM.ActiveLineNumber, StringFormat='Line: {0}'}" FontWeight="Bold" Foreground="{StaticResource Accent.Error}" FontSize="11"/>
                    </Border>
                </Grid>
            </Border>

            <!-- SPLITTER 2 -->
            <GridSplitter Grid.Column="3" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="{StaticResource Border.Default}"/>

            <!-- â•â•â•â•â•â•â• RIGHT PANEL: Machine Control â•â•â•â•â•â•â• -->
            <Border Grid.Column="4" Background="{StaticResource Bg.Surface1}" BorderBrush="{StaticResource Border.Default}" BorderThickness="1,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="16">
                        <TextBlock Text="MACHINE CONTROL" FontWeight="Bold" Foreground="{StaticResource Text.Muted}" FontSize="11" Margin="0,0,0,16"/>
                        
                        <!-- Axis Jog (J1-J6) -->
                        <TextBlock Text="JOINT JOG" FontWeight="SemiBold" Foreground="{StaticResource Text.Primary}" FontSize="12" Margin="0,0,0,8"/>
                        
                        <!-- Using ItemsControl for dynamic joint iteration -->
                        <ItemsControl ItemsSource="{Binding RobotVM.JointSliders}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <local:AxisJogControl AxisName="{Binding Name}" 
                                                          CurrentPosition="{Binding Angle, Mode=TwoWay}" 
                                                          MinLimit="{Binding Min}" 
                                                          MaxLimit="{Binding Max}" 
                                                          Margin="0,0,0,8"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <Rectangle Height="1" Fill="{StaticResource Border.Default}" Margin="0,12"/>
                        
                        <!-- Cartesian Jog / Outputs -->
                        <TextBlock Text="CARTESIAN TCP" FontWeight="SemiBold" Foreground="{StaticResource Text.Primary}" FontSize="12" Margin="0,0,0,8"/>
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <!-- X, Y, Z -->
                            <StackPanel Grid.Row="0" Grid.Column="0" Margin="2">
                                <TextBlock Text="X" Foreground="{StaticResource Text.Muted}" FontSize="10" HorizontalAlignment="Center"/>
                                <TextBox Text="{Binding RobotVM.TcpX, StringFormat=N2}" Background="{StaticResource Bg.Deepest}" Foreground="{StaticResource Text.Primary}" BorderBrush="{StaticResource Border.Input}" TextAlignment="Center" Padding="4" IsReadOnly="True"/>
                            </StackPanel>
                            <StackPanel Grid.Row="0" Grid.Column="1" Margin="2">
                                <TextBlock Text="Y" Foreground="{StaticResource Text.Muted}" FontSize="10" HorizontalAlignment="Center"/>
                                <TextBox Text="{Binding RobotVM.TcpY, StringFormat=N2}" Background="{StaticResource Bg.Deepest}" Foreground="{StaticResource Text.Primary}" BorderBrush="{StaticResource Border.Input}" TextAlignment="Center" Padding="4" IsReadOnly="True"/>
                            </StackPanel>
                            <StackPanel Grid.Row="0" Grid.Column="2" Margin="2">
                                <TextBlock Text="Z" Foreground="{StaticResource Text.Muted}" FontSize="10" HorizontalAlignment="Center"/>
                                <TextBox Text="{Binding RobotVM.TcpZ, StringFormat=N2}" Background="{StaticResource Bg.Deepest}" Foreground="{StaticResource Text.Primary}" BorderBrush="{StaticResource Border.Input}" TextAlignment="Center" Padding="4" IsReadOnly="True"/>
                            </StackPanel>
                        </Grid>
                        
                        <Rectangle Height="1" Fill="{StaticResource Border.Default}" Margin="0,12"/>
                        
                        <!-- Master Speed / Accel -->
                        <TextBlock Text="MOTION SETTINGS" FontWeight="SemiBold" Foreground="{StaticResource Text.Primary}" FontSize="12" Margin="0,0,0,8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="60"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="40"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="30"/>
                                <RowDefinition Height="30"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Speed" Foreground="{StaticResource Text.Muted}" VerticalAlignment="Center" FontSize="11"/>
                            <Slider Grid.Row="0" Grid.Column="1" Minimum="1" Maximum="100" Value="{Binding RobotVM.SpeedPercent}" VerticalAlignment="Center" Margin="8,0"/>
                            <TextBlock Grid.Row="0" Grid.Column="2" Text="{Binding RobotVM.SpeedPercent, StringFormat='{}{0:F0}%'}" Foreground="{StaticResource Text.Primary}" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="11"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Accel" Foreground="{StaticResource Text.Muted}" VerticalAlignment="Center" FontSize="11"/>
                            <Slider Grid.Row="1" Grid.Column="1" Minimum="1" Maximum="200" Value="{Binding RobotVM.Acceleration}" VerticalAlignment="Center" Margin="8,0"/>
                            <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding RobotVM.Acceleration, StringFormat='{}{0:F0}'}" Foreground="{StaticResource Text.Primary}" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="11"/>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- BOTTOM CONSOLE (Telemetry)                                  -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="2" Background="{StaticResource Bg.Deepest}" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="32"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Console Tabs -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Background="{StaticResource Bg.Surface1}">
                    <Border BorderBrush="{StaticResource Accent.Sim}" BorderThickness="0,0,0,2" Padding="16,0">
                        <TextBlock Text="TERMINAL" Foreground="{StaticResource Text.Primary}" FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                    </Border>
                    <Border Padding="16,0" Cursor="Hand">
                        <TextBlock Text="OUTPUT" Foreground="{StaticResource Text.Muted}" FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                    </Border>
                    <Border Padding="16,0" Cursor="Hand">
                        <TextBlock Text="DEBUG CONSOLE" Foreground="{StaticResource Text.Muted}" FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                    </Border>
                    <Border Padding="16,0" Cursor="Hand">
                        <TextBlock Text="PROBLEMS" Foreground="{StaticResource Text.Muted}" FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                    </Border>
                </StackPanel>
                
                <!-- Console Content: Currently placeholder for logging system -->
                <ScrollViewer Grid.Row="1" Background="{StaticResource Bg.Deepest}" Padding="10">
                    <TextBlock FontFamily="Consolas" FontSize="12" Foreground="{StaticResource Text.Muted}">
                        <Run Text="[SYS] FR-STUDIO Core Engine Started." Foreground="{StaticResource Accent.Real}"/><LineBreak/>
                        <Run Text="[SYS] Connecting to Robot Hardware (Simulation)..."/><LineBreak/>
                        <Run Text="[SYS] Loaded URDF: irb120_workspace.urdf"/><LineBreak/>
                        <Run Text="[WRN] Teach velocity limited to 250mm/s in T1 mode." Foreground="#E5C07B"/><LineBreak/>
                        <Run Text="[SYS] Ready."/>
                    </TextBlock>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- COMMAND PALETTE OVERLAY (Ctrl+Shift+P)                         -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Grid.RowSpan="3" Visibility="{Binding IsCommandPaletteOpen, Converter={StaticResource BoolToVisibility}}">
            <!-- Dark backdrop -->
            <Border Background="#80000000" />
            <!-- Palette card -->
            <Border HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,80,0,0"
                    Width="520" Background="{StaticResource Bg.Surface2}" CornerRadius="8"
                    BorderBrush="{StaticResource Accent.Sim}" BorderThickness="2">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="30" Opacity="0.35" ShadowDepth="8"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*" MaxHeight="360"/>
                    </Grid.RowDefinitions>
                    <!-- Search box -->
                    <Border Grid.Row="0" Padding="16,12" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,0,0,1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="âŒ˜" FontSize="16" Foreground="{StaticResource Accent.Sim}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <TextBox Grid.Column="1" Text="{Binding CommandPaletteQuery, UpdateSourceTrigger=PropertyChanged}"
                                     FontSize="14" BorderThickness="0" Background="Transparent" Foreground="{StaticResource Text.Primary}"
                                     VerticalContentAlignment="Center"/>
                            <TextBlock Grid.Column="2" Text="ESC" FontSize="10" Foreground="{StaticResource Text.Muted}" VerticalAlignment="Center"
                                       Cursor="Hand" Margin="8,0,0,0">
                                <TextBlock.InputBindings>
                                    <MouseBinding Gesture="LeftClick" Command="{Binding ToggleCommandPaletteCommand}"/>
                                </TextBlock.InputBindings>
                            </TextBlock>
                        </Grid>
                    </Border>
                    <!-- Results -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="4">
                        <ItemsControl ItemsSource="{Binding CommandPaletteResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Background="Transparent" BorderThickness="0" Margin="4,2" MinHeight="40" HorizontalContentAlignment="Stretch"
                                            Command="{Binding DataContext.ExecuteAndClosePaletteCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}">
                                        <Grid Margin="8,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="28"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding IconGlyph}" FontSize="14" Foreground="{StaticResource Text.Primary}" VerticalAlignment="Center"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding DisplayName}" FontSize="13" FontWeight="SemiBold" Foreground="{StaticResource Text.Primary}"/>
                                                <TextBlock Text="{Binding Description}" FontSize="10" Foreground="{StaticResource Text.Muted}"/>
                                            </StackPanel>
                                            <TextBlock Grid.Column="2" Text="{Binding Category}" FontSize="10" Foreground="{StaticResource Accent.Sim}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    <!-- SETTINGS MODAL OVERLAY -->
                    <Border Grid.RowSpan="3" Background="#80000000" Visibility="{Binding IsSettingsOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Border Width="700" Height="500" Background="{StaticResource Bg.Deepest}" CornerRadius="8"
                                BorderBrush="{StaticResource Border.Default}" BorderThickness="1">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="40" Opacity="0.5" ShadowDepth="10"/>
                            </Border.Effect>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="50"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Header -->
                                <Border Grid.Row="0" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,0,0,1" Background="{StaticResource Bg.Surface2}" CornerRadius="8,8,0,0">
                                    <Grid Margin="16,0">
                                        <TextBlock Text="âš™ System Settings" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource Text.Primary}" VerticalAlignment="Center"/>
                                        <Button Content="âœ•" HorizontalAlignment="Right" VerticalAlignment="Center" Width="32" Height="32"
                                                Background="Transparent" BorderThickness="0" Foreground="{StaticResource Text.Muted}"
                                                Command="{Binding CloseSettingsCommand}">
                                            <Button.Resources>
                                                <Style TargetType="Border">
                                                    <Setter Property="CornerRadius" Value="4"/>
                                                </Style>
                                            </Button.Resources>
                                        </Button>
                                    </Grid>
                                </Border>

                                <!-- Body -->
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="200"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Left Nav -->
                                    <Border Grid.Column="0" BorderBrush="{StaticResource Border.Default}" BorderThickness="0,0,1,0" Background="{StaticResource Bg.Surface1}">
                                        <TabControl x:Name="SettingsNav" TabStripPlacement="Left" BorderThickness="0" Background="Transparent" Margin="0,8">
                                            <TabItem Header="ðŸ“„ General"/>
                                            <TabItem Header="ðŸ¤– Robot Model">
                                                <StackPanel Margin="20">
                                                    <TextBlock Text="Robot Kinematic Model" FontWeight="Bold" FontSize="14" Margin="0,0,0,15" Foreground="{StaticResource Text.Primary}"/>
                                                    <TextBlock Text="Use the Command Palette (Ctrl+Shift+P) and search 'Load URDF' to select a robot model." Foreground="{StaticResource Text.Muted}" TextWrapping="Wrap"/>
                                                    <TextBlock Text="{Binding SettingsVM.UrdfPath}" Margin="0,15,0,0" Foreground="{StaticResource Text.Primary}" TextWrapping="Wrap" FontWeight="SemiBold"/>
                                                </StackPanel>
                                            </TabItem>
                                            <TabItem Header="âš™ Encoder Config" IsSelected="True">
                                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                                    <StackPanel Margin="20">
                                                        <TextBlock Text="Encoder Hardware Parameters" FontWeight="Bold" FontSize="14" Margin="0,0,0,15" Foreground="{StaticResource Text.Primary}"/>
                                                        
                                                        <Grid Margin="0,0,0,10">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="150"/>
                                                                <ColumnDefinition Width="150"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="Resolution (bits):" VerticalAlignment="Center" Foreground="{StaticResource Text.Muted}"/>
                                                            <TextBox Grid.Column="1" Text="{Binding SettingsVM.EncoderResolution}" Padding="6,4" Background="{StaticResource Bg.Deepest}" BorderBrush="{StaticResource Border.Input}" Foreground="{StaticResource Text.Primary}"/>
                                                        </Grid>

                                                        <Grid Margin="0,0,0,10">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="150"/>
                                                                <ColumnDefinition Width="150"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="Gear Ratio:" VerticalAlignment="Center" Foreground="{StaticResource Text.Muted}"/>
                                                            <TextBox Grid.Column="1" Text="{Binding SettingsVM.GearRatio}" Padding="6,4" Background="{StaticResource Bg.Deepest}" BorderBrush="{StaticResource Border.Input}" Foreground="{StaticResource Text.Primary}"/>
                                                        </Grid>

                                                        <Grid Margin="0,0,0,10">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="150"/>
                                                                <ColumnDefinition Width="150"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="Counts/Revolution:" VerticalAlignment="Center" Foreground="{StaticResource Text.Muted}"/>
                                                            <TextBox Grid.Column="1" Text="{Binding SettingsVM.CountsPerRevolution}" Padding="6,4" Background="{StaticResource Bg.Deepest}" BorderBrush="{StaticResource Border.Input}" Foreground="{StaticResource Text.Primary}"/>
                                                        </Grid>

                                                        <Grid Margin="0,0,0,10">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="150"/>
                                                                <ColumnDefinition Width="150"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="Direction Invert:" VerticalAlignment="Center" Foreground="{StaticResource Text.Muted}"/>
                                                            <CheckBox Grid.Column="1" IsChecked="{Binding SettingsVM.DirectionInvert}" VerticalAlignment="Center"/>
                                                        </Grid>

                                                        <Grid Margin="0,0,0,10">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="150"/>
                                                                <ColumnDefinition Width="150"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="Offset Calibration:" VerticalAlignment="Center" Foreground="{StaticResource Text.Muted}"/>
                                                            <TextBox Grid.Column="1" Text="{Binding SettingsVM.OffsetCalibration}" Padding="6,4" Background="{StaticResource Bg.Deepest}" BorderBrush="{StaticResource Border.Input}" Foreground="{StaticResource Text.Primary}"/>
                                                        </Grid>
                                                    </StackPanel>
                                                </ScrollViewer>
                                            </TabItem>
                                            <TabItem Header="ðŸ”Œ Communication"/>
                                            <TabItem Header="ðŸ“ Units"/>
                                            <TabItem Header="ðŸŽ¨ Theme"/>
                                        </TabControl>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
